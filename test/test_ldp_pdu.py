from trasa.ldp_pdu import LdpPdu, parse_ldp_pdu
import socket
import struct
import unittest

def build_byte_string(hex_stream):
    values = [int(x, 16) for x in map(''.join, zip(*[iter(hex_stream)]*2))]
    return struct.pack("!" + "B" * len(values), *values)

class LdpPduTestCase(unittest.TestCase):
    def test_single_message_parses(self):
        serialised_pdu = build_byte_string("00010026ac1a016500000100001c0000000804000004002dc00004010004ac1a01650402000400000001")
        pdu = parse_ldp_pdu(serialised_pdu)
        self.assertEqual(pdu.version, 1)
        self.assertEqual(pdu.lsr_id, "172.26.1.101")
        self.assertEqual(pdu.label_space_id, 0)
        self.assertEqual(len(pdu.messages), 1)

    def test_single_message_packs(self):
        messages = [build_byte_string("0100001c0000000804000004002dc00004010004ac1a01650402000400000001")]
        expected_serialised_pdu = build_byte_string("00010026ac1a016500000100001c0000000804000004002dc00004010004ac1a01650402000400000001")
        pdu = LdpPdu(1, "172.26.1.101", 0, messages)
        serialised_pdu = pdu.pack()
        self.assertEqual(serialised_pdu, expected_serialised_pdu)

    def test_pdu_with_two_messages_parses(self):
        serialised_pdu = build_byte_string("0001019e4206060600000300001a000000030101001200010a0143060a0138060606060642060606040000170000000401000007020001180101010200000400000010040000170000000501000007020001180202020200000400000011040000170000000601000007020001180303030200000400000012040000170000000701000007020001180404040200000400000013040000170000000801000007020001180505050200000400000014040000170000000901000007020001184206060200000400000003040000170000000a01000007020001180606060200000400000003040000170000000b01000007020001180707070200000400000015040000170000000c01000007020001180a010c0200000400000016040000170000000d01000007020001180a01170200000400000017040000170000000e01000007020001180a012d0200000400000018040000170000000f01000007020001180a01220200000400000019040000170000001001000007020001180a01380200000400000003040000170000001101000007020001180a01430200000400000003")
        pdu = parse_ldp_pdu(serialised_pdu)
        self.assertEqual(pdu.version, 1)
        self.assertEqual(pdu.lsr_id, "66.6.6.6")
        self.assertEqual(pdu.label_space_id, 0)
        self.assertEqual(len(pdu.messages), 15)
